<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true">

    <!-- ========================= -->
    <!-- Service metadata variables -->
    <!-- ========================= -->
    <property name="SERVICE_NAME" value="${service.name:-unknown-service}"/>
    <property name="SERVICE_VERSION" value="${service.version:-0.0.1}"/>
    <property name="LOG_FORMAT" value="${LOG_FORMAT:-text}"/>

    <!-- ========================= -->
    <!-- Console appender (text) -->
    <!-- ========================= -->
    <appender name="CONSOLE_TEXT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>
                %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level
                [${SERVICE_NAME} v${SERVICE_VERSION}]
                %marker %logger{36} - %msg%n
            </pattern>
        </encoder>
    </appender>

    <!-- ========================= -->
    <!-- Console appender (JSON) -->
    <!-- ========================= -->
    <appender name="CONSOLE_JSON" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp>
                    <timeZone>UTC</timeZone>
                </timestamp>
                <pattern>
                    <pattern>{"level":"%level"}</pattern>
                </pattern>
                <pattern>
                    <pattern>{"thread":"%thread"}</pattern>
                </pattern>
                <pattern>
                    <pattern>{"logger":"%logger"}</pattern>
                </pattern>
                <message/>
                <pattern>
                    <pattern>{"marker":"%marker"}</pattern>
                </pattern>
                <pattern>
                    <pattern>{"service":"${SERVICE_NAME}","version":"${SERVICE_VERSION}"}</pattern>
                </pattern>
                <stackTrace/>
            </providers>
        </encoder>
    </appender>

    <!-- ========================= -->
    <!-- Root logger -->
    <!-- ========================= -->
    <root level="INFO">
        <!-- Switch based on LOG_FORMAT env/system property -->
        <appender-ref ref="CONSOLE_TEXT" condition='''"${LOG_FORMAT}" == "text"'''/>
        <appender-ref ref="CONSOLE_JSON" condition='''"${LOG_FORMAT}" == "json"'''/>
    </root>

    <!-- ========================= -->
    <!-- Noise reduction -->
    <!-- ========================= -->
    <logger name="org.apache.kafka" level="WARN"/>
    <logger name="org.springframework.kafka" level="WARN"/>
    <logger name="org.springframework.boot" level="INFO"/>

</configuration>
